---
title: "Workflow Information"
package: AnVIL
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Workflow Information}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} 
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    eval =  AnVIL::gcloud_exists(), collapse = TRUE, cache = TRUE
)
options(width=75)
```

# Run avworkflow_info()

Load AnVIL package.

```{r, message = FALSE, eval = TRUE, cache = FALSE}
library(AnVIL)
```

## Multiple workflows in one job 

When submissionId of the job is provided, workflow information can be 
retrieved as below. 

```{r, eval = FALSE}
submissionId <- "9385fd75-4cb7-470f-9e07-1979e2c8f193"
res1 <- avworkflow_info(submissionId)
```

Workflow information for sample submissionId 
"9385fd75-4cb7-470f-9e07-1979e2c8f193" retrieved as above is stored 
as res1.rds. 

```{r, message=FALSE, warning=FALSE}
res1 <- readRDS(system.file(package = "AnVIL", "data", "res1.rds"))

## view result of avworkflow_info()
res1
```

Inputs and outputs are stored as list, and could be expanded by 
tidyr::unnest_wider().

```{r, message=FALSE, warning=FALSE}
library(tidyr)

## expand inputs
res1 |> 
    select(workflowId, inputs) |>
    tidyr::unnest_wider(inputs)

## expand outputs
res1 |> 
    select(workflowId, outputs) |>
    tidyr::unnest_wider(outputs)

## expand outputs (name starts with RcollectlWorkflow)
res1 |> 
    select(workflowId, outputs) |> 
    tidyr::unnest_wider(outputs) |>
    unnest_longer(starts_with("RcollectlWorkflow"), keep_empty = TRUE)
```

## Multiple files in one workflow

When submissionId is not provided, most recent workflow job is used, and 
workflow information can be retrieved as below. 

```{r, eval = FALSE}
res2 <- avworkflow_info()
```

Workflow information for sample submissionId 
"35280de1-42d8-492b-aa8c-5feff984bffa" retrieved as above is stored 
as res2.rds. 

```{r, message=FALSE, warning=FALSE}
res2 <- readRDS(system.file(package = "AnVIL", "data", "res2.rds"))

## view result of avworkflow_info()
res2
```

Inputs and outputs are stored as list, and could be expanded by 
tidyr::unnest_wider().

```{r, message=FALSE, warning=FALSE}
library(tidyr)

## expand inputs
res2 |> 
    select(workflowId, inputs) |>
    tidyr::unnest_wider(inputs)

## expand outputs
res2 |> 
    select(workflowId, outputs) |>
    tidyr::unnest_wider(outputs)

## expand one column of outputs 
res2 |> 
    select(workflowId, outputs) |>
    tidyr::unnest_wider(outputs) |>
    select(RcollectlWorkflowDelayedArrayParameters.Rcollectl_result) |>
    unnest_longer("RcollectlWorkflowDelayedArrayParameters.Rcollectl_result")

## expand one column of outputs and view full result
res2 |> 
    select(workflowId, outputs) |>
    tidyr::unnest_wider(outputs) |>
    select(RcollectlWorkflowDelayedArrayParameters.Rcollectl_result) |>
    unnest_longer("RcollectlWorkflowDelayedArrayParameters.Rcollectl_result") |>
    as.vector()
```

# Session information

```{r sessionInfo}
sessionInfo()
```
