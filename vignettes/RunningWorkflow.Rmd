---
title: "Running an AnVIL workflow within R"
author:
- name: Kayla Interdonato
  affiliation: Roswell Park Comprehensive Cancer Center
- name: Martin Morgan
  affiliation: Roswell Park Comprehensive Cancer Center
  email: Martin.Morgan@RoswellPark.org
package: AnVIL
output:
  BiocStyle::html_document
abstract: |
  This vignette will demonstrate how a user can edit, run, and stop a 
  Terra / AnVIL workflow from within their R session. The configuration of the 
  workflow can be retrieved and edited. Then this new configuration can be 
  sent back to the Terra / AnVIL workspace for future use. With the new 
  configuration defined the user will then be able to run the workflow as well 
  as stop any jobs from running.
vignette: |
  %\VignetteIndexEntry{Running an AnVIL workflow within R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    eval =  AnVIL::gcloud_exists(), collapse = TRUE, cache = TRUE
)
options(width=75)
```

# Installation

Install the _AnVIL_ package with 

```{r, eval = FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager", repos = "https://cran.r-project.org")
BiocManager::install("AnVIL")
```

Once installed, load the package with

```{r, message = FALSE, eval = TRUE, cache = FALSE}
library(AnVIL)
```

# Demo with DESeq2 workspace

## Setting up the workspace

The first step will be to define the namespace and name of the workspace to be 
used with the functions. In our case we will be using the Bioconductor AnVIL 
namespace and a DESeq2 workflow as the intened workspace.

```{r workspace}
avworkspace_namespace("bioconductor-rpci-anvil")
avworkspace_name("Bioconductor-Workflow-DESeq2")
```

## Retriving the configuration

Within a workspace there are workflows that define inputs, outputs and certain
code execution. These workflows contain configurations that can be retrieved 
with `avworkflow_configuration_get`. This function requires the namespace and 
the name of the workflow.

```{r configuration}
config <- avworkflow_configuration_get("bioconductor-rpci-anvil", "AnVILBulkRNASeq")
config
```

## Changing the inputs / outputs

There is a lot of information contained in the configuration but the only 
variables of interest to the user would be the inputs and outputs. In our case
the inputs and outputs are pre-defined so we don't have to do anything to them. 
But for some workflows these inputs / outputs maybe blank and therefore would 
need to be defined by the user. We will change one of our inputs values to show
how this would be done.

There are two functions to help users easily see the content of the inputs and 
outputs, they are `avworkflow_configuration_template_inputs` and 
`avworkflow_configuration_template_outputs`. These functions display the 
information in a `data.frame` structure which users are most likely familiar 
with.

```{r inputs_outputs}
inputs <- avworkflow_configuration_template_inputs(config)
outputs <- avworkflow_configuration_template_outputs(config)

inputs
outputs
```

We will change the fourth value of our inputs since this is an arbitrary string
variable in our workflow.

```{r change_input}
inputs$attribute[4] <- "\"new_index_name\""
inputs
```

## Update configuration

Since the inputs have been modified we need to put this information into 
the configuration of the workflow. We can do this with 
`avworkflow_configuration_update()`. By default this function will take the 
inputs and outputs of the original configuration, just in case there were no 
changes to one of them (like in our example our outputs weren't changed).

```{r update_config}
new_config <- avworkflow_configuration_update(config, inputs)
new_config
```

## Setting the new configuration

Now that the configuration is updated we can set this new configuration with 
`avworkflow_configuration_set()`. This function will update the Terra / AnVIL
workflow. 

```{r set_config}
avworkflow_configuration_set(new_config)
```

## Running the new workflow

To finally run the new workflow we need to know the name of the data set to be 
used in the workflow. This can be discovered by looking at the table of 
interest and grabbing the name of the data set.

```{r entityName}
entityName <- avtable("participant_set") |>
    pull(participant_set_id) |>
    head(1)
avworkflow_run(new_config, entityName)
```

We can see that the workflow is running by using the `avworkflow_jobs` function.

```{r checking_workflow}
avworkflow_jobs()
```

## Stopping the workflow

If a user wants to stop a workflow from running they can utilize 
`avworkflow_stop()`. This will change the status of the job from 'Submitted' to
'Aborted'.

```{r stop_workflow}
avworkflow_stop()

avworkflow_jobs()
```

## Session info

```{r sessionInfo}
sessionInfo()
```
